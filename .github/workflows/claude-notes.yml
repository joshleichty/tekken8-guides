name: Handle user note with Claude

on:
  repository_dispatch:
    types: [user-note]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  triage-and-implement:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install dependencies
        run: npm ci

      - name: Run Claude on note
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            A user left the following note on the Tekken 8 character guides website.
            Your job is to evaluate it and, if it's a legitimate actionable request, implement the fix and open a PR.

            ---
            **Note ID:** ${{ github.event.client_payload.note_id }}
            **Page:** ${{ github.event.client_payload.page }}
            **Context:** ${{ github.event.client_payload.context }}
            **Message:** ${{ github.event.client_payload.message }}
            **Selected text:** ${{ github.event.client_payload.selected_text }}
            **CSS selector:** ${{ github.event.client_payload.selector }}
            **Selected HTML:** ${{ github.event.client_payload.selected_html }}
            **Screenshot:** ${{ github.event.client_payload.screenshot_url }}
            **Submitted at:** ${{ github.event.client_payload.created_at }}
            ---

            Follow the instructions in .github/prompts/note-triage.md to decide what to do and how to do it.
          claude_args: "--max-turns 30 --model claude-opus-4-6"
