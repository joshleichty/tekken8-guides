name: Handle user note with Claude

on:
  repository_dispatch:
    types: [user-note]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  triage-and-implement:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install dependencies
        run: npm ci

      - name: Run Claude on note
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            A note was left on the Tekken 8 character guides website requesting a change.
            Read the note, figure out what's being asked, and implement it if it's a small to medium change.
            If it's a massive change, or you get stuck and can't figure it out, just exit without creating a PR.
            Don't build or test — just make the changes and open the PR.

            ---
            **Note ID:** ${{ github.event.client_payload.note_id }}
            **Page:** ${{ github.event.client_payload.page }}
            **Context:** ${{ github.event.client_payload.context }}
            **Message:** ${{ github.event.client_payload.message }}
            **Selected text:** ${{ github.event.client_payload.selected_text }}
            **CSS selector:** ${{ github.event.client_payload.selector }}
            **Selected HTML:** ${{ github.event.client_payload.selected_html }}
            **Screenshot:** ${{ github.event.client_payload.screenshot_url }}
            **Submitted at:** ${{ github.event.client_payload.created_at }}
            ---

            Follow the instructions in .github/prompts/note-triage.md for guidance on locating files and formatting the PR.
          claude_args: "--max-turns 30 --model claude-opus-4-6 --dangerously-skip-permissions"

      - name: Auto-merge Claude's PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="note/${{ github.event.client_payload.note_id }}"
          PR_NUMBER=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number' 2>/dev/null || true)
          if [ -n "$PR_NUMBER" ]; then
            echo "Merging PR #$PR_NUMBER from branch $BRANCH"
            gh pr merge "$PR_NUMBER" --squash --delete-branch
          else
            echo "No open PR found for branch $BRANCH — Claude may have skipped this note"
          fi
